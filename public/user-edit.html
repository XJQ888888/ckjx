<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>编辑用户 - 长坤机械订单管理系统</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
body{font-family:'Noto Sans SC',sans-serif;background:#0f172a;}
.card{background:linear-gradient(135deg,rgba(30,41,59,.8) 0%,rgba(51,65,85,.6) 100%);border:1px solid rgba(148,163,184,.2);backdrop-filter:blur(10px);}
.input-field{background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.3);transition:all .3s ease;}
.input-field:focus{border-color:#06b6d4;box-shadow:0 0 0 3px rgba(6,182,212,.1);}
.btn-primary{background:linear-gradient(135deg,#06b6d4,#0891b2);transition:all .3s ease;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(6,182,212,.3);}
.permission-group{border:1px solid rgba(148,163,184,.2);border-radius:8px;padding:16px;margin-bottom:16px;}
.permission-item{margin-bottom:8px;}
</style>
</head>
<body class="min-h-screen flex items-center justify-center">
<div class="w-full max-w-4xl p-6">
  <div class="card rounded-xl p-8">
    <h2 class="text-2xl font-bold text-white mb-6">编辑用户</h2>
    <form id="user-form" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">用户名</label>
          <input type="text" id="username" class="input-field w-full px-3 py-2 rounded-lg text-white" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">新密码</label>
          <input type="password" id="password" class="input-field w-full px-3 py-2 rounded-lg text-white" placeholder="留空表示不修改">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">角色</label>
          <select id="role" class="input-field w-full px-3 py-2 rounded-lg text-white">
            <option value="user">普通用户</option>
            <option value="admin">管理员</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">状态</label>
          <select id="status" class="input-field w-full px-3 py-2 rounded-lg text-white">
            <option value="active">正常</option>
            <option value="inactive">禁用</option>
          </select>
        </div>
      </div>
      
      <div>
        <h3 class="text-lg font-semibold text-white mb-4">权限设置</h3>
        <div id="permissions-container"></div>
      </div>
      
      <div class="flex items-center justify-end space-x-4">
        <button type="button" onclick="history.back()" class="px-6 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg">取消</button>
        <button type="submit" class="btn-primary px-6 py-2 rounded-lg text-white font-medium">保存修改</button>
      </div>
    </form>
  </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get('id');

// 加载权限架构
async function loadPermissionSchema() {
  const res = await fetch('http://192.168.10.22:3001/api/permissions/schema', {
    headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
  });
  const schema = await res.json();
  
  const container = document.getElementById('permissions-container');
  let html = '';
  let currentGroup = '';
  
  schema.forEach(perm => {
    if (perm.group !== currentGroup) {
      if (currentGroup) html += '</div>';
      html += `<div class="permission-group">
                <h4 class="text-white font-medium mb-3">${perm.group}</h4>`;
      currentGroup = perm.group;
    }
    
    html += `<label class="permission-item flex items-center space-x-3 text-slate-300">
              <input type="checkbox" name="permissions" value="${perm.code}" 
                     class="text-cyan-500 rounded">
              <span>${perm.name}</span>
            </label>`;
  });
  
  if (currentGroup) html += '</div>';
  container.innerHTML = html;
}

// 加载用户数据
async function loadUserData() {
  const res = await fetch(`http://192.168.10.22:3001/api/users/${userId}`, {
    headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
  });
  const user = await res.json();
  
  document.getElementById('username').value = user.username;
  document.getElementById('role').value = user.role;
  document.getElementById('status').value = user.status;
  
  // 设置权限
  user.permissions.forEach(perm => {
    const checkbox = document.querySelector(`input[name="permissions"][value="${perm}"]`);
    if (checkbox) checkbox.checked = true;
  });
}

// 保存用户数据
document.getElementById('user-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const permissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked'))
    .map(cb => cb.value);
  
  const userData = {
    username: document.getElementById('username').value,
    password: document.getElementById('password').value,
    role: document.getElementById('role').value,
    status: document.getElementById('status').value,
    permissions
  };
  
  const res = await fetch(`http://192.168.10.22:3001/api/users/${userId}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      Authorization: 'Bearer ' + localStorage.getItem('token')
    },
    body: JSON.stringify(userData)
  });
  
  if (res.ok) {
    alert('用户已更新');
    location.href = 'settings.html';
  } else {
    alert('更新失败');
  }
});

// 页面加载
document.addEventListener('DOMContentLoaded', async () => {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user || user.role !== 'admin') {
    alert('无权限');
    location.href = 'dashboard.html';
    return;
  }
  
  await loadPermissionSchema();
  await loadUserData();
});
</script>
</body>
</html>