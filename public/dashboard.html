<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>长坤机械订单管理系统 - 仪表盘</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Noto Sans SC',sans-serif;background:#0f172a;}
    .sidebar{background:linear-gradient(180deg,#1e293b 0%,#334155 100%);border-right:1px solid rgba(148,163,184,.2);}
    .content-area{background:#0f172a;}
    .nav-item{transition:all .3s ease;border-left:3px solid transparent;}
    .nav-item:hover,.nav-item.active{background:rgba(6,182,212,.1);border-left-color:#06b6d4;}
    .card{background:linear-gradient(135deg,rgba(30,41,59,.8) 0%,rgba(51,65,85,.6) 100%);border:1px solid rgba(148,163,184,.2);backdrop-filter:blur(10px);}
    .stat-card{background:linear-gradient(135deg,rgba(6,182,212,.1) 0%,rgba(8,145,178,.05) 100%);border:1px solid rgba(6,182,212,.3);transition:all .3s ease;cursor:pointer;}
    .stat-card:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(6,182,212,.2);}
    .urgent-order{background:linear-gradient(135deg,rgba(239,68,68,.1) 0%,rgba(220,38,38,.05) 100%);border:1px solid rgba(239,68,68,.3);}
    .order-row{transition:all .3s ease;cursor:pointer;}
    .order-row:hover{background:rgba(6,182,212,.05);}
    .status-badge{padding:4px 8px;border-radius:12px;font-size:12px;font-weight:500;}
    .status-tech{background:rgba(139,92,246,.2);color:#a78bfa;}
    .status-layout{background:rgba(99,102,241,.2);color:#818cf8;}
    .status-laser{background:rgba(59,130,246,.2);color:#60a5fa;}
    .status-bend{background:rgba(16,185,129,.2);color:#34d399;}
    .status-weld{background:rgba(245,158,11,.2);color:#fbbf24;}
    .status-paint{background:rgba(239,68,68,.2);color:#f87171;}
    .status-delivered{background:rgba(34,197,94,.2);color:#4ade80;}
    .status-repair{background:rgba(239,68,68,.3);color:#fca5a5;}
    .hidden-amount{display:none;}
    #seven-days-table{height:520px;overflow:auto;}
    #trend-chart,#status-chart{height:220px;}
    .repair-top{order:-1;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.5);}
  </style>
</head>
<body class="min-h-screen flex">

<!-- 左侧导航 -->
<div class="sidebar w-64 flex flex-col">
  <div class="p-6 border-b border-slate-600">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-lg flex items-center justify-center"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
      <div><h1 class="text-white font-bold text-lg">长坤机械</h1><p class="text-slate-400 text-xs">订单管理系统</p></div>
    </div>
  </div>
  <nav class="flex-1 p-4">
    <ul class="space-y-2">
      <li><a href="dashboard.html" class="nav-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-white"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg><span>仪表盘</span></a></li>
      <li><a href="orders.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>订单管理</span></a></li>
      <li id="settings-nav" style="display:none;"><a href="settings.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14,12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4,2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24,0-.43.17-.47.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-.22-.08-.47,0-.59.22L2.74,8.87C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s.02.64.07.94l-2.03,1.58c-.18.14-.23.41-.12.61l1.92,3.32c.12.22.37.29.59.22l2.39-.96c.5.38,1.03.7,1.62.94l.36,2.54c.05.24.24.41.48.41h3.84c.24,0,.44-.17.47-.41l.36-2.54c.59-.24,1.13-.56,1.62-.94l2.39.96c.22.08.47,0,.59-.22l1.92-3.32c.12-.22.07-.47-.12-.61L19.14,12.94zM12,15.6c-1.98,0-3.6-1.62-3.6-3.6s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg><span>系统设置</span></a></li>
    </ul>
  </nav>
  <div class="p-4 border-t border-slate-600">
    <div class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-full flex items-center justify-center"><span id="user-avatar" class="text-white text-sm font-bold">用</span></div>
      <div class="flex-1">
        <p id="username" class="text-white text-sm font-medium">用户名</p>
        <p id="user-role" class="text-slate-400 text-xs">角色</p>
      </div>
      <button id="logout-btn" class="text-slate-400 hover:text-white"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg></button>
    </div>
  </div>
</div>

<!-- 右侧内容 -->
<div class="content-area flex-1 flex flex-col">
  <header class="bg-slate-800 border-b border-slate-700 px-6 py-4">
    <div class="flex items-center justify-between">
      <div><h2 class="text-2xl font-bold text-white">仪表盘</h2><p class="text-slate-400 text-sm">实时监控订单状态和生产进度</p></div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2"><div id="data-status" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span class="text-slate-400 text-sm">数据同步中</span></div>
        <button id="refresh-btn" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm transition-colors">手动刷新</button>
      </div>
    </div>
  </header>

  <main class="flex-1 p-6 overflow-auto">
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
      <div id="total-orders" class="stat-card p-6 rounded-xl"><div class="flex items-center justify-between"><div><p class="text-slate-400 text-sm">总订单数</p><p class="text-3xl font-bold text-white mt-1" id="total-count">0</p></div><div class="w-12 h-12 bg-cyan-500 bg-opacity-20 rounded-lg flex items-center justify-center"><svg class="w-6 h-6 text-cyan-400" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg></div></div></div>
      <div id="pending-orders" class="stat-card p-6 rounded-xl"><div class="flex items-center justify-between"><div><p class="text-slate-400 text-sm">待交货订单</p><p class="text-3xl font-bold text-white mt-1" id="pending-count">0</p></div><div class="w-12 h-12 bg-orange-500 bg-opacity-20 rounded-lg flex items-center justify-center"><svg class="w-6 h-6 text-orange-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div></div></div>
      <div id="repair-orders" class="stat-card p-6 rounded-xl"><div class="flex items-center justify-between"><div><p class="text-slate-400 text-sm">返修订单</p><p class="text-3xl font-bold text-white mt-1" id="repair-count">0</p></div><div class="w-12 h-12 bg-red-500 bg-opacity-20 rounded-lg flex items-center justify-center"><svg class="w-6 h-6 text-red-400" fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div></div></div>
      <div id="today-orders" class="stat-card p-6 rounded-xl"><div class="flex items-center justify-between"><div><p class="text-slate-400 text-sm">今日新增</p><p class="text-3xl font-bold text-white mt-1" id="today-count">0</p></div><div class="w-12 h-12 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center"><svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></div></div></div>
    </div>

    <!-- 图表 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <div class="card p-6 rounded-xl">
        <div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-white">订单趋势</h3>
          <div class="flex items-center space-x-2 text-sm text-slate-400">
            <label>维度:</label>
            <select id="trend-dimension" class="input-field px-2 py-1 rounded text-white text-sm" onchange="updateTrendChart()" style="background:#1e293b;color:#fff;border:1px solid #475569;">
              <option value="customer" style="background:#1e293b;color:#fff;">按客户</option>
              <option value="date" style="background:#1e293b;color:#fff;">按时间</option>
              <option value="type" style="background:#1e293b;color:#fff;">按类别</option>
              <option value="spec" style="background:#1e293b;color:#fff;">按规格</option>
            </select>
            <label>周期:</label>
            <select id="trend-period" class="input-field px-2 py-1 rounded text-white text-sm" onchange="updateTrendChart()" style="background:#1e293b;color:#fff;border:1px solid #475569;">
              <option value="week" style="background:#1e293b;color:#fff;">本周</option>
              <option value="month" style="background:#1e293b;color:#fff;">本月</option>
              <option value="year" style="background:#1e293b;color:#fff;">本年</option>
            </select>
          </div>
        </div>
        <div id="trend-chart"></div>
      </div>
      <div class="card p-6 rounded-xl">
        <div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-white">订单状态分布</h3><button id="refresh-status" class="text-cyan-400 hover:text-cyan-300 text-sm">刷新</button></div>
        <div id="status-chart"></div>
      </div>
    </div>

    <!-- 最近7天待交货 -->
    <div class="card p-6 rounded-xl">
      <div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-white">最近7天待交货订单</h3><span class="text-slate-400 text-sm">点击订单查看详情</span></div>
      <div id="seven-days-table" class="overflow-x-auto"><table class="w-full"><thead><tr class="border-b border-slate-700"><th class="text-left py-3 px-4 text-slate-400 text-sm font-medium">订单名称</th><th class="text-left py-3 px-4 text-slate-400 text-sm font-medium">客户名称</th><th class="text-left py-3 px-4 text-slate-400 text-sm font-medium">订单类别</th><th class="text-left py-3 px-4 text-slate-400 text-sm font-medium">当前状态</th><th class="text-left py-3 px-4 text-slate-400 text-sm font-medium cursor-pointer" id="stay-header">状态停留(h)</th><th class="text-left py-3 px-4 text-slate-400 text-sm font-medium">交货日期</th></tr></thead><tbody id="orders-table"></tbody></table></div>
    </div>
  </main>
</div>

<!-- 状态停留明细模态框 -->
<div id="stay-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="card p-6 w-full max-w-4xl rounded-xl">
    <div class="flex items-center justify-between mb-4"><h3 class="text-xl font-semibold text-white">各订单状态停留时间</h3><button id="close-stay" class="text-slate-400 hover:text-white"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div>
    <div id="stay-body" class="text-slate-300 text-sm"></div>
  </div>
</div>

<script>
let ordersData=[],trendChart=null,statusChart=null,showAmount=true;
document.addEventListener('DOMContentLoaded',()=>{
  checkUser();
  loadConfig();
  loadDashboardData();
  setInterval(loadDashboardData,5000);
  document.getElementById('close-stay').onclick=()=>document.getElementById('stay-modal').classList.add('hidden');
  document.getElementById('stay-header').onclick=showAllStay;
});

async function checkUser(){
  const user=JSON.parse(localStorage.getItem('user'));
  if(!user)location.href='index.html';
  document.getElementById('username').textContent=user.username;
  document.getElementById('user-avatar').textContent=user.username.charAt(0);
  document.getElementById('user-role').textContent=user.role==='admin'?'管理员':'普通用户';
  document.getElementById('logout-btn').onclick=()=>{localStorage.clear();location.href='index.html';};
  const res=await fetch('http://192.168.10.22:3001/api/user/permissions',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const perms=await res.json();
  if(perms.includes('system.show') || user.role==='admin') document.getElementById('settings-nav').style.display='block';
}

async function loadConfig(){
  try{
    const res=await fetch('http://192.168.10.22:3001/api/config/show_amount',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
    const data=await res.json();
    showAmount=data.value==='1';
  }catch{showAmount=true;}
  if(!showAmount)document.querySelectorAll('.hidden-amount').forEach(el=>el.classList.add('hidden'));
}

async function loadDashboardData(){
  const res=await fetch('http://192.168.10.22:3001/api/dashboard',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const{statistics}=await res.json();
  updateStatistics(statistics);
  await loadPending7();
  updateTrendChart();
  updateStatusChart();
}

async function loadPending7(){
  const today = new Date().toISOString().slice(0,10);
  const future7 = new Date(Date.now() + 7 * 24 * 3600 * 1000).toISOString().slice(0,10);
  const res = await fetch(
    `http://192.168.10.22:3001/api/orders?delivery_date_start=${today}&delivery_date_end=${future7}&status_ne=已交货&limit=50`,
    { headers: { Authorization: 'Bearer ' + localStorage.getItem('token') } }
  );
  const { orders } = await res.json();
  renderPending7(orders);
}
function renderPending7(list){
  const box = document.getElementById('orders-table');
  box.innerHTML = '';
  list.sort((a,b)=> (b.status==='返修'?1:0) - (a.status==='返修'?1:0) );
  list.forEach(o => {
    const tr = document.createElement('tr');
    tr.className = 'order-row border-b border-slate-700 ' + (o.status==='返修'?'repair-top':'');
    tr.onclick = () => location.href = `orders.html?id=${o.id}`;
    const stay = calcStayHours(o);
    tr.innerHTML = `
      <td class="py-3 px-4 text-white">${o.order_name}</td>
      <td class="py-3 px-4 text-slate-300">${o.customer_name}</td>
      <td class="py-3 px-4 text-slate-300">${o.order_type}</td>
      <td class="py-3 px-4"><span class="status-badge ${getStatusClass(o.status)}">${o.status}</span></td>
      <td class="py-3 px-4 text-slate-300">${stay}</td>
      <td class="py-3 px-4 text-slate-300">${o.delivery_date}</td>
    `;
    box.appendChild(tr);
  });
}
function calcStayHours(order){
  const start=new Date(order.created_at||order.order_date);
  const end=order.status==='已交货'?new Date(order.updated_at||Date.now()):new Date();
  return effectiveHours(start,end);
}
function effectiveHours(start,end){
  let ms=0, cur=new Date(start);
  while(cur<end){
    const h=cur.getHours();
    if(h>=8&&h<18) ms+=Math.min(60*60*1000, end-cur);
    cur=new Date(cur.getTime()+60*60*1000);
  }
  return (ms/3600000).toFixed(2);
}

function getStatusClass(status){
  const map={
    '技术拆分':'status-tech','排版':'status-layout','激光切割':'status-laser','折弯':'status-bend',
    '焊接':'status-weld','涂装':'status-paint','已交货':'status-delivered','返修':'status-repair','二次交货':'status-delivered'
  };
  return map[status]||'status-tech';
}

async function showAllStay(){
  const rows=Array.from(document.querySelectorAll('#orders-table tr'));
  if(!rows.length){alert('暂无订单');return;}
  const body=document.getElementById('stay-body');
  body.innerHTML='';
  for(const tr of rows){
    const orderName=tr.children[0].textContent;
    const orderId=tr.onclick.toString().match(/id=(\d+)/)?.[1];
    if(!orderId)continue;
    try{
      const res=await fetch(`http://192.168.10.22:3001/api/orders/stay-detail?id=${orderId}`,{
        headers:{Authorization:'Bearer '+localStorage.getItem('token')}
      });
      const data=await res.json();
      const map={};
      data.forEach(d=>{map[d.status]=(map[d.status]||0)+parseFloat(d.hours);});
      const line=Object.entries(map).map(([s,h])=>`${s}:${h.toFixed(2)}h`).join(' | ');
      body.insertAdjacentHTML('beforeend',`<div class="py-1 text-white">${orderName} → ${line}</div>`);
    }catch(e){
      body.insertAdjacentHTML('beforeend',`<div class="py-1 text-red-400">${orderName} → 获取失败</div>`);
    }
  }
  document.getElementById('stay-modal').classList.remove('hidden');
}

function updateStatistics(s){
  document.getElementById('total-count').textContent=s.total;
  document.getElementById('pending-count').textContent=s.pending ?? 0;
  document.getElementById('repair-count').textContent=s.repair ?? 0;
  document.getElementById('today-count').textContent=s.today ?? 0;
}

async function updateTrendChart(){
  const dimension=document.getElementById('trend-dimension').value;
  const period=document.getElementById('trend-period').value;
  const res=await fetch(`http://192.168.10.22:3001/api/dashboard/trend?dimension=${dimension}&period=${period}`,{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  const option={
    backgroundColor:'transparent',textStyle:{color:'#cbd5e1'},
    tooltip:{trigger:'axis',backgroundColor:'rgba(30,41,59,.9)',borderColor:'rgba(148,163,184,.2)',textStyle:{color:'#e2e8f0'}},
    grid:{left:'3%',right:'4%',bottom:'3%',containLabel:true},
    xAxis:{type:'category',data:data.labels,axisLine:{lineStyle:{color:'#475569'}},axisLabel:{color:'#94a3b8',rotate:45}},
    yAxis:{type:'value',axisLine:{lineStyle:{color:'#475569'}},axisLabel:{color:'#94a3b8'},splitLine:{lineStyle:{color:'#334155'}}},
    series:[{data:data.values,type:'bar',barWidth:'60%',itemStyle:{color:{type:'linear',x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:'#06b6d4'},{offset:1,color:'#0891b2'}]},borderRadius:[4,4,0,0]},emphasis:{itemStyle:{shadowBlur:10,shadowColor:'rgba(6,182,212,.5)'}}}]
  };
  if(!trendChart)trendChart=echarts.init(document.getElementById('trend-chart'));
  trendChart.setOption(option);
}

async function updateStatusChart(){
  const res=await fetch('http://192.168.10.22:3001/api/dashboard/status',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  const option={
    backgroundColor:'transparent',textStyle:{color:'#cbd5e1'},
    tooltip:{trigger:'item',backgroundColor:'rgba(30,41,59,.9)',borderColor:'rgba(148,163,184,.2)',textStyle:{color:'#e2e8f0'}},
    legend:{
      orient:'vertical',
      left:'left',
      textStyle:{color:'#94a3b8'},
      itemGap:20,   // 加大垂直间距
      itemHeight:24  // 单行高度
    },
    series:[{name:'订单状态',type:'pie',radius:'50%',data,emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:'rgba(0,0,0,.5)'}},itemStyle:{borderRadius:5,borderColor:'#1e293b',borderWidth:2},color:['#8b5cf6','#3b82f6','#10b981','#f59e0b','#ef4444','#22c55e','#f97316']}]
  };
  if(!statusChart)statusChart=echarts.init(document.getElementById('status-chart'));
  statusChart.setOption(option);
}

document.getElementById('refresh-btn').onclick=loadDashboardData;
document.getElementById('trend-dimension').onchange=updateTrendChart;
document.getElementById('trend-period').onchange=updateTrendChart;
document.getElementById('refresh-status').onclick=updateStatusChart;
document.getElementById('total-orders').onclick=()=>location.href='orders.html';
document.getElementById('pending-orders').onclick=()=>location.href='orders.html?filter=pending';
document.getElementById('repair-orders').onclick=()=>location.href='orders.html?filter=repair';
document.getElementById('today-orders').onclick=()=>location.href='orders.html?filter=today';
</script>
</body>
</html>