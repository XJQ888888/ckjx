<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>长坤机械订单管理系统 - 系统设置</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
body{font-family:'Noto Sans SC',sans-serif;background:#0f172a;}
.sidebar{background:linear-gradient(180deg,#1e293b 0%,#334155 100%);border-right:1px solid rgba(148,163,184,.2);}
.content-area{background:#0f172a;}
.nav-item{transition:all .3s ease;border-left:3px solid transparent;}
.nav-item:hover,.nav-item.active{background:rgba(6,182,212,.1);border-left-color:#06b6d4;}
.card{background:linear-gradient(135deg,rgba(30,41,59,.8) 0%,rgba(51,65,85,.6) 100%);border:1px solid rgba(148,163,184,.2);backdrop-filter:blur(10px);}
.tab-button{transition:all .3s ease;border-bottom:2px solid transparent;}
.tab-button.active{border-bottom-color:#06b6d4;color:#06b6d4;}
.input-field{background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.3);transition:all .3s ease;}
.input-field:focus{border-color:#06b6d4;box-shadow:0 0 0 3px rgba(6,182,212,.1);}
.btn-primary{background:linear-gradient(135deg,#06b6d4,#0891b2);transition:all .3s ease;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(6,182,212,.3);}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);transition:all .3s ease;}
.btn-danger:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(239,68,68,.3);}
</style>
</head>
<body class="min-h-screen flex">
<!-- 左侧导航 -->
<div class="sidebar w-64 flex flex-col">
  <div class="p-6 border-b border-slate-600">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-lg flex items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <div>
        <h1 class="text-white font-bold text-lg">长坤机械</h1>
        <p class="text-slate-400 text-xs">订单管理系统</p>
      </div>
    </div>
  </div>
  <nav class="flex-1 p-4">
    <ul class="space-y-2">
      <li><a href="dashboard.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg><span>仪表盘</span></a></li>
      <li><a href="orders.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>订单管理</span></a></li>
      <li><a href="analytics.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>数据分析</span></a></li>
      <li><a href="settings.html" class="nav-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-white"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14,12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4,2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24,0-.43.17-.47.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-.22-.08-.47,0-.59.22L2.74,8.87C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s.02.64.07.94l-2.03,1.58c-.18.14-.23.41-.12.61l1.92,3.32c.12.22.37.29.59.22l2.39-.96c.5.38,1.03.7,1.62.94l.36,2.54c.05.24.24.41.48.41h3.84c.24,0,.44-.17.47-.41l.36-2.54c.59-.24,1.13-.56,1.62-.94l2.39.96c.22.08.47,0,.59-.22l1.92-3.32c.12-.22.07-.47-.12-.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg><span>系统设置</span></a></li>
    </ul>
  </nav>
  <div class="p-4 border-t border-slate-600">
    <div class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-full flex items-center justify-center"><span id="user-avatar" class="text-white text-sm font-bold">用</span></div>
      <div class="flex-1">
        <p id="username" class="text-white text-sm font-medium">用户名</p>
        <p id="user-role" class="text-slate-400 text-xs">角色</p>
      </div>
      <button id="logout-btn" class="text-slate-400 hover:text-white"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg></button>
    </div>
  </div>
</div>

<!-- 右侧内容 -->
<div class="content-area flex-1 flex flex-col">
  <header class="bg-slate-800 border-b border-slate-700 px-6 py-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-white">系统设置</h2>
        <p class="text-slate-400 text-sm">管理系统配置和用户权限</p>
      </div>
    </div>
  </header>

  <main class="flex-1 p-6 overflow-auto">
    <!-- 标签页导航 -->
    <div class="border-b border-slate-700 mb-6">
      <nav class="flex space-x-8">
        <button class="tab-button active py-3 px-1 text-white font-medium" data-tab="users">用户管理</button>
        <button class="tab-button py-3 px-1 text-slate-400 hover:text-white font-medium" data-tab="types">订单类别管理</button>
        <button class="tab-button py-3 px-1 text-slate-400 hover:text-white font-medium" data-tab="specs">规格选项管理</button>
        <button class="tab-button py-3 px-1 text-slate-400 hover:text-white font-medium" data-tab="units">单位选项管理</button>
        <button class="tab-button py-3 px-1 text-slate-400 hover:text-white font-medium" data-tab="recycle">回收站管理</button>
        <button class="tab-button py-3 px-1 text-slate-400 hover:text-white font-medium" data-tab="backup">备份与恢复</button>
        <button class="tab-button py-3 px-1 text-slate-400 hover:text-white font-medium" data-tab="print">打印模板</button>
        <button class="tab-button py-3 px-1 text-slate-400 hover:text-white font-medium" data-tab="system">系统配置</button>
      </nav>
    </div>

    <!-- 用户管理 -->
    <div id="users-tab" class="tab-content">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-white">用户列表</h3>
        <button id="add-user-btn" class="btn-primary px-6 py-2 rounded-lg text-white font-medium">新增用户</button>
      </div>
      <div class="card rounded-xl overflow-hidden">
        <table class="w-full"><thead class="bg-slate-700"><tr>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">用户名</th>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">角色</th>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">状态</th>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">操作</th>
        </tr></thead><tbody id="users-table"></tbody></table>
      </div>
    </div>

    <!-- 订单类别管理 -->
    <div id="types-tab" class="tab-content hidden">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-white">订单类别</h3>
        <button id="add-type-btn" class="btn-primary px-6 py-2 rounded-lg text-white font-medium">新增类别</button>
      </div>
      <div class="card rounded-xl overflow-hidden">
        <table class="w-full"><thead class="bg-slate-700"><tr>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">类别名称</th>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">操作</th>
        </tr></thead><tbody id="types-table"></tbody></table>
      </div>
    </div>

    <!-- 规格选项管理 -->
    <div id="specs-tab" class="tab-content hidden">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-white">规格选项</h3>
        <button id="add-spec-btn" class="btn-primary px-6 py-2 rounded-lg text-white font-medium">新增规格</button>
      </div>
      <div class="card rounded-xl overflow-hidden">
        <table class="w-full"><thead class="bg-slate-700"><tr>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">规格值</th>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">操作</th>
        </tr></thead><tbody id="specs-table"></tbody></table>
      </div>
    </div>

    <!-- 单位选项管理 -->
    <div id="units-tab" class="tab-content hidden">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-white">单位选项</h3>
        <button id="add-unit-btn" class="btn-primary px-6 py-2 rounded-lg text-white font-medium">新增单位</button>
      </div>
      <div class="card rounded-xl overflow-hidden">
        <table class="w-full"><thead class="bg-slate-700"><tr>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">单位值</th>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">操作</th>
        </tr></thead><tbody id="units-table"></tbody></table>
      </div>
    </div>

    <!-- 回收站管理 -->
    <div id="recycle-tab" class="tab-content hidden">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-white">回收站</h3>
        <button id="clear-recycle-btn" class="btn-danger px-4 py-2 rounded-lg text-white text-sm">清空回收站</button>
      </div>
      <div class="card rounded-xl overflow-hidden">
        <table class="w-full"><thead class="bg-slate-700"><tr>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">订单名称</th>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">客户名称</th>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">删除时间</th>
          <th class="text-left py-3 px-4 text-slate-300 text-sm font-medium">操作</th>
        </tr></thead><tbody id="recycle-table"></tbody></table>
      </div>
    </div>

    <!-- 备份与恢复 -->
    <div id="backup-tab" class="tab-content hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="card p-6 rounded-xl"><h3 class="text-xl font-semibold text-white mb-4">数据备份</h3>
          <div class="space-y-4">
            <div><label class="block text-sm font-medium text-slate-300 mb-1">备份类型</label>
              <select id="backup-type" class="input-field w-full px-3 py-2 rounded-lg text-white"><option value="full">完整备份</option><option value="orders">仅订单数据</option><option value="users">仅用户数据</option></select>
            </div>
            <div><label class="block text-sm font-medium text-slate-300 mb-1">备份路径</label>
              <div class="flex items-center space-x-2"><input type="text" id="backup-path" class="input-field flex-1 px-3 py-2 rounded-lg text-white" placeholder="选择备份路径" readonly>
                <button type="button" id="select-backup-path" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg text-sm">选择路径</button></div>
            </div>
            <button id="start-backup" class="btn-primary w-full py-2 rounded-lg text-white font-medium">开始备份</button>
          </div>
        </div>
        <div class="card p-6 rounded-xl"><h3 class="text-xl font-semibold text-white mb-4">数据恢复</h3>
          <div class="space-y-4">
            <div><label class="block text-sm font-medium text-slate-300 mb-1">备份文件</label>
              <div class="flex items-center space-x-2"><input type="text" id="restore-file" class="input-field flex-1 px-3 py-2 rounded-lg text-white" placeholder="选择备份文件" readonly>
                <button type="button" id="select-restore-file" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg text-sm">选择文件</button></div>
            </div>
            <div><label class="block text-sm font-medium text-slate-300 mb-2">恢复选项</label>
              <div class="space-y-1 text-slate-300 text-sm"><label class="flex items-center"><input type="checkbox" id="restore-users" class="mr-2" checked> 用户数据</label>
                <label class="flex items-center"><input type="checkbox" id="restore-orders" class="mr-2" checked> 订单数据</label>
                <label class="flex items-center"><input type="checkbox" id="restore-settings" class="mr-2"> 系统配置</label></div>
            </div>
            <button id="start-restore" class="btn-danger w-full py-2 rounded-lg text-white font-medium">开始恢复</button>
          </div>
        </div>
      </div>
      <div class="card p-6 rounded-xl"><h3 class="text-xl font-semibold text-white mb-4">备份历史</h3>
        <table class="w-full"><thead class="bg-slate-700"><tr>
          <th class="text-left py-2 px-4 text-slate-300 text-sm">备份时间</th>
          <th class="text-left py-2 px-4 text-slate-300 text-sm">类型</th>
          <th class="text-left py-2 px-4 text-slate-300 text-sm">文件大小</th>
          <th class="text-left py-2 px-4 text-slate-300 text-sm">操作</th>
        </tr></thead><tbody id="backup-history"></tbody></table>
      </div>
    </div>

    <!-- 打印模板 -->
    <div id="print-tab" class="tab-content hidden">
      <div class="card p-6 rounded-xl">
        <h3 class="text-xl font-semibold text-white mb-4">打印模板自定义</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">上传模板文件（.docx/.xlsx）</label>
            <div class="flex items-center space-x-4">
              <input type="file" id="template-file" accept=".docx,.xlsx" class="hidden">
              <button type="button" onclick="document.getElementById('template-file').click()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg text-sm">选择文件</button>
              <span id="template-file-name" class="text-slate-400 text-sm">未选择文件</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1">模板类型</label>
            <select id="template-type" class="input-field w-full px-3 py-2 rounded-lg text-white">
              <option value="html">HTML模板</option>
              <option value="word">Word模板</option>
              <option value="excel">Excel模板</option>
            </select>
          </div>
          <div id="html-template-section">
            <label class="block text-sm font-medium text-slate-300 mb-1">模板内容（HTML）</label>
            <textarea id="print-template" class="input-field w-full px-3 py-2 rounded-lg text-white font-mono text-sm" rows="12" placeholder="可使用的变量：{{order_name}}、{{customer_name}}、{{order_type}}、{{quantity}}、{{specification}}、{{unit}}、{{delivery_date}}"></textarea>
          </div>
          <div class="flex items-center justify-end space-x-4">
            <button id="upload-template" onclick="uploadTemplate()" class="btn-primary px-4 py-2 rounded-lg text-white text-sm">上传模板</button>
            <button id="reset-template" onclick="resetPrintTemplate()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg text-sm">恢复默认</button>
            <button id="save-template" onclick="savePrintTemplate()" class="btn-primary px-6 py-2 rounded-lg text-white font-medium">保存模板</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 系统配置 -->
    <div id="system-tab" class="tab-content hidden">
      <div class="card p-6 rounded-xl space-y-6">
        <div>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="show-amount-toggle" class="text-cyan-500">
            <span class="text-white font-medium">显示金额字段</span>
          </label>
          <p class="text-slate-400 text-sm mt-1">关闭后，所有页面将隐藏金额相关字段</p>
        </div>
        <div>
          <button id="save-system-config" class="btn-primary px-6 py-2 rounded-lg text-white font-medium">保存配置</button>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
/* ---------- 通用函数 ---------- */
function switchTab(tab){
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active','text-white'));
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active','text-white');
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));
  document.getElementById(`${tab}-tab`).classList.remove('hidden');
  loadTabData(tab);
}
async function loadTabData(tab){
  if(tab==='users')loadUsers();
  if(tab==='types')loadTypes();
  if(tab==='specs')loadSpecs();
  if(tab==='units')loadUnits();
  if(tab==='recycle')loadRecycle();
  if(tab==='backup')loadBackupHistory();
  if(tab==='print')loadPrintTemplate();
  if(tab==='system')loadSystemConfig();
}

/* ---------- 用户 ---------- */
async function loadUsers(){
  const res=await fetch('http://192.168.10.22:3001/api/users',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  let users=await res.json(); if(!Array.isArray(users))users=[];
  const tbody=document.getElementById('users-table');
  tbody.innerHTML=users.map(u=>`
    <tr ondblclick="editUser(${u.id})" class="border-b border-slate-700 hover:bg-slate-800 transition-colors cursor-pointer">
      <td class="py-3 px-4 text-white">${u.username}</td>
      <td class="py-3 px-4 text-slate-300">${u.role==='admin'?'管理员':'普通用户'}</td>
      <td class="py-3 px-4 ${u.status==='active'?'text-green-400':'text-red-400'}">${u.status==='active'?'正常':'禁用'}</td>
      <td class="py-3 px-4"><div class="flex items-center space-x-2">
        <button onclick="event.stopPropagation();toggleUserStatus(${u.id})" class="text-orange-400 hover:text-orange-300 text-sm">${u.status==='active'?'禁用':'启用'}</button>
        <button onclick="event.stopPropagation();deleteUser(${u.id})" class="text-red-400 hover:text-red-300 text-sm">删除</button>
      </div></td>
    </tr>`).join('');
}
function editUser(id){
  location.href=`user-edit.html?id=${id}`;
}
async function addUser(){
  location.href='user-add.html';
}
async function toggleUserStatus(id){
  await fetch(`http://192.168.10.22:3001/api/users/${id}/toggle`,{method:'PUT',headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  loadUsers();
}
async function deleteUser(id){
  if(!confirm('确定删除？'))return;
  await fetch(`http://192.168.10.22:3001/api/users/${id}`,{method:'DELETE',headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  loadUsers();
}

/* ---------- 类别 ---------- */
async function loadTypes(){
  const res=await fetch('http://192.168.10.22:3001/api/config/categories',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  let types=await res.json(); if(!Array.isArray(types))types=[];
  document.getElementById('types-table').innerHTML=types.map(t=>`
    <tr class="border-b border-slate-700 hover:bg-slate-800 transition-colors">
      <td class="py-3 px-4 text-white">${t.name}</td>
      <td class="py-3 px-4"><button onclick="deleteType(${t.id})" class="text-red-400 hover:text-red-300 text-sm">删除</button></td>
    </tr>`).join('');
}
async function addType(){
  const name=prompt('请输入类别名称'); if(!name)return;
  await fetch('http://192.168.10.22:3001/api/config/categories',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({name})});
  loadTypes();
}
async function deleteType(id){
  if(!confirm('确定删除？'))return;
  await fetch(`http://192.168.10.22:3001/api/config/categories/${id}`,{method:'DELETE',headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  loadTypes();
}

/* ---------- 规格 ---------- */
async function loadSpecs(){
  const res=await fetch('http://192.168.10.22:3001/api/config/spec_options',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  let specs=[]; try{specs=JSON.parse(data.cfg_value||'[]');}catch{}
  if(!Array.isArray(specs))specs=[];
  document.getElementById('specs-table').innerHTML=specs.map(s=>`
    <tr class="border-b border-slate-700 hover:bg-slate-800 transition-colors">
      <td class="py-3 px-4 text-white">${s}</td>
      <td class="py-3 px-4"><button onclick="deleteSpec('${s}')" class="text-red-400 hover:text-red-300 text-sm">删除</button></td>
    </tr>`).join('');
}
async function addSpec(){
  const name=prompt('请输入规格值'); if(!name)return;
  const res=await fetch('http://192.168.10.22:3001/api/config/spec_options',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  let specs=[]; try{specs=JSON.parse(data.cfg_value||'[]');}catch{}
  if(!Array.isArray(specs))specs=[];
  specs.push(name);
  await fetch('http://192.168.10.22:3001/api/config/spec_options',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({value:JSON.stringify(specs)})});
  loadSpecs();
}
async function deleteSpec(value){
  const res=await fetch('http://192.168.10.22:3001/api/config/spec_options',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  let specs=[]; try{specs=JSON.parse(data.cfg_value||'[]');}catch{}
  if(!Array.isArray(specs))specs=[];
  specs=specs.filter(s=>s!==value);
  await fetch('http://192.168.10.22:3001/api/config/spec_options',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({value:JSON.stringify(specs)})});
  loadSpecs();
}

/* ---------- 单位 ---------- */
async function loadUnits(){
  const res=await fetch('http://192.168.10.22:3001/api/config/unit_options',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  let units=[]; try{units=JSON.parse(data.cfg_value||'[]');}catch{}
  if(!Array.isArray(units))units=[];
  document.getElementById('units-table').innerHTML=units.map(u=>`
    <tr class="border-b border-slate-700 hover:bg-slate-800 transition-colors">
      <td class="py-3 px-4 text-white">${u}</td>
      <td class="py-3 px-4"><button onclick="deleteUnit('${u}')" class="text-red-400 hover:text-red-300 text-sm">删除</button></td>
    </tr>`).join('');
}
async function addUnit(){
  const name=prompt('请输入单位值'); if(!name)return;
  const res=await fetch('http://192.168.10.22:3001/api/config/unit_options',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  let units=[]; try{units=JSON.parse(data.cfg_value||'[]');}catch{}
  if(!Array.isArray(units))units=[];
  units.push(name);
  await fetch('http://192.168.10.22:3001/api/config/unit_options',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({value:JSON.stringify(units)})});
  loadUnits();
}
async function deleteUnit(value){
  const res=await fetch('http://192.168.10.22:3001/api/config/unit_options',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  let units=[]; try{units=JSON.parse(data.cfg_value||'[]');}catch{}
  if(!Array.isArray(units))units=[];
  units=units.filter(u=>u!==value);
  await fetch('http://192.168.10.22:3001/api/config/unit_options',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({value:JSON.stringify(units)})});
  loadUnits();
}

/* ---------- 回收站 ---------- */
async function loadRecycle(){
  const res=await fetch('http://192.168.10.22:3001/api/orders/recycle',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  let orders=await res.json(); if(!Array.isArray(orders))orders=[];
  document.getElementById('recycle-table').innerHTML=orders.map(o=>`
    <tr class="border-b border-slate-700 hover:bg-slate-800 transition-colors">
      <td class="py-3 px-4 text-white">${o.order_name}</td>
      <td class="py-3 px-4 text-slate-300">${o.customer_name}</td>
      <td class="py-3 px-4 text-slate-300">${new Date(o.deleted_at).toLocaleString()}</td>
      <td class="py-3 px-4"><div class="flex items-center space-x-2">
        <button onclick="restoreOrder(${o.id})" class="text-green-400 hover:text-green-300 text-sm">恢复</button>
        <button onclick="permanentDelete(${o.id})" class="text-red-400 hover:text-red-300 text-sm">彻底删除</button>
      </div></td>
    </tr>`).join('');
}
async function restoreOrder(id){
  await fetch(`http://192.168.10.22:3001/api/orders/${id}/restore`,{method:'POST',headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  loadRecycle();
}
async function permanentDelete(id){
  if(!confirm('彻底删除后不可恢复，确定？'))return;
  await fetch(`http://192.168.10.22:3001/api/orders/${id}/permanent`,{method:'DELETE',headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  loadRecycle();
}
function clearRecycleBin(){
  if(!confirm('确定清空回收站？'))return;
  fetch('http://192.168.10.22:3001/api/orders/recycle',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}})
    .then(r=>r.json())
    .then(async orders=>{
      if(!Array.isArray(orders))orders=[];
      for(const o of orders){
        await fetch(`http://192.168.10.22:3001/api/orders/${o.id}/permanent`,{method:'DELETE',headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
      }
      loadRecycle();
    });
}

/* ---------- 备份 ---------- */
function selectBackupPath(){
  const path=prompt('请输入备份路径（含文件名）','C:\\ckjx_backup_full.sql');
  if(path)document.getElementById('backup-path').value=path;
}
function selectRestoreFile(){
  const path=prompt('请输入备份文件路径','C:\\ckjx_backup_full.sql');
  if(path)document.getElementById('restore-file').value=path;
}
async function startBackup(){
  const path=document.getElementById('backup-path').value;
  if(!path)return alert('请选择路径');
  await fetch('http://192.168.10.22:3001/api/backup',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({path,type:document.getElementById('backup-type').value})});
  alert('备份完成');
  loadBackupHistory();
}
async function startRestore(){
  const path=document.getElementById('restore-file').value;
  if(!path)return alert('请选择文件');
  const flags={
    users:document.getElementById('restore-users').checked,
    orders:document.getElementById('restore-orders').checked,
    settings:document.getElementById('restore-settings').checked
  };
  await fetch('http://192.168.10.22:3001/api/restore',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({path,...flags})});
  alert('恢复完成');
}
async function loadBackupHistory(){
  const res=await fetch('http://192.168.10.22:3001/api/backup/history',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  let list=await res.json(); if(!Array.isArray(list))list=[];
  document.getElementById('backup-history').innerHTML=list.map(b=>`
    <tr class="border-b border-slate-700 hover:bg-slate-800 transition-colors">
      <td class="py-2 px-4 text-slate-300">${new Date(b.time).toLocaleString()}</td>
      <td class="py-2 px-4 text-slate-300">${b.type}</td>
      <td class="py-2 px-4 text-slate-300">${b.size}</td>
      <td class="py-2 px-4"><button onclick="deleteBackup('${b.file}')" class="text-red-400 hover:text-red-300 text-sm">删除</button></td>
    </tr>`).join('');
}
async function deleteBackup(file){
  if(!confirm('确定删除备份？'))return;
  await fetch('http://192.168.10.22:3001/api/backup',{method:'DELETE',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({file})});
  loadBackupHistory();
}

/* ---------- 打印模板 ---------- */
async function loadPrintTemplate(){
  const res=await fetch('http://192.168.10.22:3001/api/print-template',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  document.getElementById('print-template').value=data.template||'';
}
async function savePrintTemplate(){
  const tpl=document.getElementById('print-template').value;
  await fetch('http://192.168.10.22:3001/api/print-template',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({template:tpl})});
  alert('模板已保存');
}
function resetPrintTemplate(){
  document.getElementById('print-template').value='<h1>{{order_name}}</h1><p>客户：{{customer_name}}</p>';
}
async function uploadTemplate(){
  const fileInput=document.getElementById('template-file');
  const file=fileInput.files[0];
  if(!file)return alert('请先选择文件');
  const form=new FormData();
  form.append('template',file);
  const res=await fetch('http://192.168.10.22:3001/api/print-template/upload',{
    method:'POST',
    headers:{Authorization:'Bearer '+localStorage.getItem('token')},
    body:form
  });
  if(res.ok){
    const data=await res.json();
    alert(data.message);
  }else{
    alert('上传失败');
  }
}
document.getElementById('template-file').addEventListener('change',function(){
  const file=this.files[0];
  if(!file)return;
  document.getElementById('template-file-name').textContent=file.name;
  uploadTemplate();
});

/* ---------- 系统配置 ---------- */
async function loadSystemConfig(){
  const res=await fetch('http://192.168.10.22:3001/api/config/show_amount',{headers:{Authorization:'Bearer '+localStorage.getItem('token')}});
  const data=await res.json();
  document.getElementById('show-amount-toggle').checked=data.value==='1';
}

/* ---------- 事件绑定 ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  const user=JSON.parse(localStorage.getItem('user'));
  if(!user||user.role!=='admin'){alert('无权限');location.href='dashboard.html';return;}
  document.getElementById('username').textContent=user.username;
  document.getElementById('user-avatar').textContent=user.username.charAt(0);
  document.getElementById('user-role').textContent='管理员';
  document.getElementById('logout-btn').onclick=()=>{localStorage.clear();location.href='index.html';};

  document.querySelectorAll('.tab-button').forEach(btn=>{btn.addEventListener('click',()=>switchTab(btn.dataset.tab));});

  document.getElementById('add-user-btn').addEventListener('click',addUser);
  document.getElementById('add-type-btn').addEventListener('click',addType);
  document.getElementById('add-spec-btn').addEventListener('click',addSpec);
  document.getElementById('add-unit-btn').addEventListener('click',addUnit);
  document.getElementById('clear-recycle-btn').addEventListener('click',clearRecycleBin);
  document.getElementById('select-backup-path').addEventListener('click',selectBackupPath);
  document.getElementById('start-backup').addEventListener('click',startBackup);
  document.getElementById('select-restore-file').addEventListener('click',selectRestoreFile);
  document.getElementById('start-restore').addEventListener('click',startRestore);
  document.getElementById('save-template').addEventListener('click',savePrintTemplate);
  document.getElementById('reset-template').addEventListener('click',resetPrintTemplate);
  document.getElementById('save-system-config').addEventListener('click',async()=>{
    const v=document.getElementById('show-amount-toggle').checked?'1':'0';
    await fetch('http://192.168.10.22:3001/api/config/show_amount',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+localStorage.getItem('token')},body:JSON.stringify({value:v})});
    alert('配置已保存');
  });

  switchTab('users');
});
</script>
</body></html>